(function(c){c.widget("ui.pattern",c.ui.mouse,{widgetEventPrefix:"pattern",options:{arrowCorrectImage:"",arrowIncorrectImage:"",clearDelay:200,gridSize:3,lineColor:"#888",lineOpacity:.5,lineWidth:20,multiSelect:!1,showPattern:!0,preDefinedPattern:[],showLines:!0},_create:function(){var a;this.element.addClass("ui-pattern ui-widget");!0===this.options.disabled?this.element.addClass("ui-state-disabled"):this.element.addClass("ui-state-default");(a=c("<canvas></canvas>"))&&a[0].getContext&&(a.addClass("ui-patter-line-container").css({opacity:this.options.lineOpacity}).appendTo(this.element),
this._linecontainer=a,this._canvasSupported=!0);this._nodecontainer=c("<div></div>").addClass("ui-patter-node-container").appendTo(this.element);!0===this._canvasSupported&&(this._arrowcontainer=c("<canvas></canvas>").addClass("ui-patter-arrow-container").appendTo(this.element));this._pattern=[];this._cachedCoordinates=[];this._previousNode=this._timer=null;this._createGrid();this._setArrowCorrect();this._setArrowIncorrect();this.options.distance=0;this._mouseInit()},destroy:function(){this.element.unbind("."+
this.widgetName).removeClass("ui-pattern ui-widget ui-state-default ui-state-disabled").children().remove();this._mouseDestroy();return this},_setOption:function(a,b){c.Widget.prototype._setOption.apply(this,arguments);switch(a){case "lineOpacity":!0===this._canvasSupported&&this._linecontainer.css("opacity",this.options.lineOpacity);break;case "gridSize":this._clear();this._createGrid();break;case "disabled":!0===b?(this._clear(),this.element.addClass("ui-state-disabled").removeClass("ui-state-default")):
this.element.addClass("ui-state-default").removeClass("ui-state-disabled");break;case "arrowCorrectImage":this._setArrowCorrect();break;case "arrowIncorrectImage":this._setArrowIncorrect()}},_mouseDrag:function(a){var b,d=this;if(!0!==this._started)return!1;b=this.element.find(".ui-pattern-node").filter(function(){return this!==d._previousNode[0]&&(!0===d.options.multiSelect||"selected"!==c(this).attr("selected"))}).hitTest(a.pageX-this._nodecontainer.offset().left,a.pageY-this._nodecontainer.offset().top);
b.length&&this._selectNode(c(b[0]),a);!0===this.options.showPattern&&this._drawLines(a);return!1},_mouseStart:function(a){this._clear();var b;if(!0===this.options.disabled||!0===this._waitingForClear)return!1;b=this.element.find(".ui-pattern-node").hitTest(a.pageX-this._nodecontainer.offset().left,a.pageY-this._nodecontainer.offset().top);b.length&&(this._start(),this._selectNode(c(b[0]),a));return!0},_mouseStop:function(a){this._stop(a)},_clear:function(){null!==this._timer&&(clearTimeout(this._timer),
this._timer=null);this._waitingForClear=this._started=!1;this._pattern=[];this._cachedCoordinates=[];this._previousNode=null;this.element.find(".ui-pattern-node").filter(function(){return"selected"===c(this).attr("selected")}).removeClass("ui-pattern-selected ui-pattern-correct ui-pattern-incorrect").removeAttr("selected");this._clearLines();this._clearArrows();this._setCanvasWidth()},_clearArrows:function(){var a;!0===this._canvasSupported&&(a=this._arrowcontainer[0].getContext("2d"),a.clearRect(0,
0,this._arrowcontainer[0].width,this._arrowcontainer[0].height))},_clearLines:function(){var a;!0===this._canvasSupported&&(a=this._linecontainer[0].getContext("2d"),a.clearRect(0,0,this._linecontainer[0].width,this._linecontainer[0].height))},_createGrid:function(){var a,b,d;this.temp_node=[];this._nodecontainer.children().remove();for(a=0;a<this.options.gridSize;a++){d=c("<div></div>").addClass("ui-pattern-row");for(b=0;b<this.options.gridSize;b++)this.temp_node.push(this._createNode(b,a).appendTo(d));
this._nodecontainer.append(d)}},drawPredefinedPattern:function(){var a=this.temp_node;for(y=0;y<this.options.preDefinedPattern.length;y++)node_no=this.options.preDefinedPattern[y]-1,this._cachedCoordinates.push({x:a[node_no].position().left+a[node_no].outerWidth(!0)/2,y:a[node_no].position().top+a[node_no].outerHeight(!0)/2}),a[node_no].addClass("ui-pattern-selected"),a[node_no].attr("selected","selected");this._clearLines();this._drawLines(!0)},_createNode:function(a,b){var d=this;return c("<a></a>").attr("href",
"#").data("x.ui-pattern-node",a).data("y.ui-pattern-node",b).addClass("ui-pattern-node").click(function(a){a.preventDefault()}).hover(function(){!0!==d.options.disabled&&c(this).addClass("ui-state-hover")},function(){c(this).removeClass("ui-state-hover")}).focus(function(){!0!==d.options.disabled?(c(".ui-pattern-node .ui-state-focus").removeClass("ui-state-focus"),c(this).addClass("ui-state-focus")):c(this).blur()}).blur(function(){c(this).removeClass("ui-state-focus")}).keydown(function(a){var b,
g=parseInt(c(this).data("x.ui-pattern-node"),10),f=parseInt(c(this).data("y.ui-pattern-node"),10);a.keyCode===c.ui.keyCode.UP?0<f&&(b=d.element.find(".ui-pattern-node").filter(function(){return parseInt(c(this).data("x.ui-pattern-node"),10)===g&&parseInt(c(this).data("y.ui-pattern-node"),10)===f-1}),b.focus(),a.preventDefault()):a.keyCode===c.ui.keyCode.DOWN?f<d.options.gridSize-1&&(b=d.element.find(".ui-pattern-node").filter(function(){return parseInt(c(this).data("x.ui-pattern-node"),10)===g&&parseInt(c(this).data("y.ui-pattern-node"),
10)===f+1}),b.focus(),a.preventDefault()):a.keyCode===c.ui.keyCode.LEFT?0<g&&(b=d.element.find(".ui-pattern-node").filter(function(){return parseInt(c(this).data("x.ui-pattern-node"),10)===g-1&&parseInt(c(this).data("y.ui-pattern-node"),10)===f}),b.focus(),a.preventDefault()):a.keyCode===c.ui.keyCode.RIGHT?g<d.options.gridSize-1&&(b=d.element.find(".ui-pattern-node").filter(function(){return parseInt(c(this).data("x.ui-pattern-node"),10)===g+1&&parseInt(c(this).data("y.ui-pattern-node"),10)===f}),
b.focus(),a.preventDefault()):a.keyCode===c.ui.keyCode.SPACE?!0!==d.options.disabled&&!0!==d._waitingForClear&&(b=d.element.find(".ui-pattern-node").filter(function(){return"selected"===c(this).attr("selected")}),b.length||d._start(),d._previousNode&&this===d._previousNode[0]||!0!==d.options.multiSelect&&"selected"===c(this).attr("selected")||(d._selectNode(c(this),a),!0===d.options.showPattern&&d._drawLines(null),a.preventDefault())):a.keyCode===c.ui.keyCode.ENTER&&!0!==d.options.disabled&&!0!==
d._waitingForClear&&(b=d.element.find(".ui-pattern-node").filter(function(){return"selected"===c(this).attr("selected")}),b.length&&d._stop(a))})},_drawArrow:function(a,b,d){var h=-Math.atan2(-(b.x-a.x),-(b.y-a.y));!0!==this._canvasSupported||null===d||void 0===d||!0===d&&null===this._arrowCorrect||!1===d&&null===this._arrowIncorrect||(b=this._arrowcontainer[0].getContext("2d"),d=!0===d?c(this._arrowCorrect):c(this._arrowIncorrect),b.translate(a.x,a.y),b.rotate(h),b.drawImage(d[0],-(d.attr("width")/
2),-(d.attr("height")/2)),b.rotate(-h),b.translate(-a.x,-a.y))},_drawArrows:function(a){var b;if(!0===this._canvasSupported&&(this._clearArrows(),!(null===a||void 0===a||!0===a&&null===this._arrowCorrect||!1===a&&null===this._arrowIncorrect)))for(b=1;b<this._cachedCoordinates.length;b++)this._drawArrow(this._cachedCoordinates[b-1],this._cachedCoordinates[b],a)},_drawLines:function(a){var b,d,c,e;if(!0===this._canvasSupported&&(this._clearLines(),this._cachedCoordinates.length)){b=this._linecontainer[0].getContext("2d");
b.beginPath();for(d=1;d<this._cachedCoordinates.length;d++)c=this._cachedCoordinates[d-1],e=this._cachedCoordinates[d],b.moveTo(c.x,c.y),b.lineTo(e.x,e.y);a&&(b.moveTo(this._cachedCoordinates[this._cachedCoordinates.length-1].x,this._cachedCoordinates[this._cachedCoordinates.length-1].y),b.lineTo(a.pageX-this._linecontainer.offset().left,a.pageY-this._linecontainer.offset().top));b.lineCap="round";b.lineJoin="round";b.lineWidth=this.options.lineWidth;b.strokeStyle=this.options.lineColor;b.stroke();
b.closePath()}},_getNode:function(a,b,d,h){var e;a+=d;b+=h;e=this.element.find(".ui-pattern-node").filter(function(){return parseInt(c(this).data("x.ui-pattern-node"),10)===a&&parseInt(c(this).data("y.ui-pattern-node"),10)===b});return!0!==this.options.multiSelect&&"selected"===e.attr("selected")?this._getNode(a,b,d,h):e},_selectNode:function(a,b){var d,c,e,g=this._previousNode,f=parseInt(a.data("x.ui-pattern-node"),10),k=parseInt(a.data("y.ui-pattern-node"),10);null!==g&&(d=parseInt(g.data("x.ui-pattern-node"),
10),c=parseInt(g.data("y.ui-pattern-node"),10),f===d?e=k>c?this._getNode(f,c,0,1):this._getNode(f,c,0,-1):k===c?e=f>d?this._getNode(d,k,1,0):this._getNode(d,k,-1,0):k-f===c-d?e=k>c?this._getNode(d,c,1,1):this._getNode(d,c,-1,-1):k+f===c+d&&(e=f>d?this._getNode(d,c,1,-1):this._getNode(d,c,-1,1)),e&&e[0]!==a[0]&&this._selectNode(e,b));g!==this._previousNode?this._selectNode(a,b):(this._previousNode=a,a.attr("selected","selected"),this._pattern.push(k*this.options.gridSize+f+1),!0===this.options.showPattern&&
a.addClass("ui-pattern-selected"),this._cachedCoordinates.length&&!0===this.options.showPattern&&this._drawArrow(this._cachedCoordinates[this._cachedCoordinates.length-1],{x:a.position().left+a.outerWidth(!0)/2,y:a.position().top+a.outerHeight(!0)/2},!0),this._cachedCoordinates.push({x:a.position().left+a.outerWidth(!0)/2,y:a.position().top+a.outerHeight(!0)/2}),this._trigger("change",b,{pattern:this._pattern}))},_setArrowCorrect:function(){this._arrowCorrect=null!==this.options.arrowCorrectImage&&
void 0!==this.options.arrowCorrectImage?c("<img/>").attr("src",this.options.arrowCorrectImage):null},_setArrowIncorrect:function(){this._arrowIncorrect=null!==this.options.arrowIncorrectImage&&void 0!==this.options.arrowIncorrectImage?c("<img/>").attr("src",this.options.arrowIncorrectImage):null},_setCanvasWidth:function(){var a,b=200,d=200;!0===this._canvasSupported&&(a=this.element.find(".ui-pattern-node"),a.length&&(b=c(a[0]).outerWidth(!0)*this.options.gridSize,d=c(a[0]).outerHeight(!0)*this.options.gridSize),
this._arrowcontainer[0].width=this._linecontainer[0].width=b,this._arrowcontainer[0].height=this._linecontainer[0].height=d)},_start:function(a){this._clear();this._trigger("start",a);this._started=!0},_stop:function(a){this._waitingForClear=!0;this._started=!1;!0===this.options.showPattern&&this._drawLines();this._trigger("stop",a,{pattern:this._pattern})},clearPattern:function(a){var b,d=this;this._waitingForClear=!1;if(!1===a||!0===this.options.showPattern)b=!0===a?"ui-pattern-correct":"ui-pattern-incorrect",
this.element.find(".ui-pattern-node").filter(function(){return"selected"===c(this).attr("selected")}).removeClass("ui-pattern-selected").addClass(b),this._drawLines(),this._drawArrows(a);this._cachedCoordinates=[];this._timer=setTimeout(function(){!0!==d._started&&d._clear()},this.options.clearDelay)},pattern:function(){return this._pattern},getPreDefinedPattern:function(){return this.options.preDefinedPattern}});c.extend(c.ui.pattern,{version:"@VERSION"});c.fn.hitTest=function(a,b){var d=[];this.each(function(){var h=
c(this).position(),e=parseInt(c(this).css("margin-left"),10)||0,g=parseInt(c(this).css("margin-top"),10)||0;h.left+e<=a&&h.left+e+c(this).outerWidth()>=a&&h.top+g<=b&&h.top+g+c(this).outerHeight()>=b&&d.push(this)});return d}})(jQuery);