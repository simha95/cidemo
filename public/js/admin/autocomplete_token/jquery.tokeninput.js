(function(b){var D={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",extraParams:"",resultsFormatter:function(b){return"<li>"+b[this.propertyToSearch]+"</li>"},tokenFormatter:function(b){return"<li><p>"+
b[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null,disableDelete:!1},E={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},
x={init:function(k,l){var a=b.extend({},D,l||{});return this.each(function(){b(this).data("tokenInputObject",new b.TokenList(this,k,a))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(b){this.data("tokenInputObject").add(b);return this},remove:function(b){this.data("tokenInputObject").remove(b);return this},destroy:function(b){this.data("tokenInputObject").destroy(b);return this},get:function(){return this.data("tokenInputObject").getTokens()},getManualsettings:function(){return this.data("tokenInputObject").getManualsettings()}};
b.fn.tokenInput=function(b){return x[b]?x[b].apply(this,Array.prototype.slice.call(arguments,1)):x.init.apply(this,arguments)};b.TokenList=function(k,l,a){function v(){null!==a.tokenLimit&&m>=a.tokenLimit&&(g.hide(),n())}function L(c){var e=a.tokenFormatter(c),e=b(e).addClass(a.classes.token).insertBefore(u);b("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(e).click(function(){B(b(this).parent());h.change();return!1});var d={id:c.id};d[a.propertyToSearch]=c[a.propertyToSearch];
b.data(e.get(0),"tokeninput",c);p=p.slice(0,q).concat([d]).concat(p.slice(q));q++;x(p,h);m+=1;null!==a.tokenLimit&&m>=a.tokenLimit&&(g.hide(),n());return e}function F(c){var e=a.onAdd;if(0<m&&a.preventDuplicates){var d=null;r.children().each(function(){var a=b(this),e=b.data(a.get(0),"tokeninput");if(e&&e.id===c.id)return d=a,!1});if(d){A(d);u.insertAfter(d);g.focus();return}}if(null==a.tokenLimit||m<a.tokenLimit)L(c),v();g.val("");n();b.isFunction(e)&&e.call(h,c)}function A(b){b.addClass(a.classes.selectedToken);
f=b.get(0);g.val("");n()}function y(b,e){b.removeClass(a.classes.selectedToken);f=null;0===e?(u.insertBefore(b),q--):1===e?(u.insertAfter(b),q++):(u.appendTo(r),q=m);g.focus()}function B(c){var e=b.data(c.get(0),"tokeninput"),d=a.onDelete,z=c.prevAll().length;z>q&&z--;c.remove();f=null;g.focus();p=p.slice(0,z).concat(p.slice(z+1));z<q&&q--;x(p,h);--m;null!==a.tokenLimit&&g.show().val("").focus();b.isFunction(d)&&d.call(h,e)}function x(c,e){var d=b.map(c,function(b){return b[a.tokenValue]});e.val(d.join(a.tokenDelimiter))}
function n(){w.hide().empty();t=null}function C(){w.css({position:"absolute",top:b(r).offset().top+b(r).outerHeight(),left:b(r).offset().left,width:b(r).width(),zindex:999}).show()}function M(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function G(c,e){if(e&&e.length){w.empty();var d=b("<ul>").appendTo(w).mouseover(function(a){H(b(a.target).closest("li"))}).mousedown(function(a){F(b(a.target).closest("li").data("tokeninput"));h.change();return!1}).hide();b.each(e,function(e,g){var f=
a.resultsFormatter(g),h=g[a.propertyToSearch],f=f.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+M(h)+")(?![^<>]*>)(?![^&;]+;)","g"),h.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+M(c)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")),f=b(f).appendTo(d);e%2?f.addClass(a.classes.dropdownItem):f.addClass(a.classes.dropdownItem2);0===e&&H(f);b.data(f.get(0),"tokeninput",g)});C();a.animateDropdown?d.slideDown("fast"):d.show()}else a.noResultsText&&(w.html("<p>"+a.noResultsText+"</p>"),C())}function H(c){c&&
(t&&(b(t).removeClass(a.classes.selectedDropdownItem),t=null),c.addClass(a.classes.selectedDropdownItem),t=c.get(0))}function N(){var c=g.val().toLowerCase();c&&c.length&&(f&&y(b(f),1),c.length>=a.minChars?(a.searchingText&&(w.html("<p>"+a.searchingText+"</p>"),C()),clearTimeout(O),O=setTimeout(function(){D(c)},a.searchDelay)):n())}function D(c){var e=c+I(),d=J.get(e);if(d)G(c,d);else if(a.url){var d=I(),f={data:{}};-1<d.indexOf("?")?(d=d.split("?"),f.url=d[0],d=d[1].split("&"),b.each(d,function(a,
b){var c=b.split("=");f.data[c[0]]=c[1]}),""!=a.extraParams&&(d=a.extraParams.split("&"),b.each(d,function(a,b){var c=b.split("=");f.data[c[0]]=c[1]}))):f.url=d;f.data[a.queryParam]=c;f.type=a.method;f.dataType=a.contentType;a.crossDomain&&(f.dataType="jsonp");f.success=function(d){b.isFunction(a.onResult)&&(d=a.onResult.call(h,d));J.add(e,a.jsonContainer?d[a.jsonContainer]:d);g.val().toLowerCase()===c&&G(c,a.jsonContainer?d[a.jsonContainer]:d)};b.ajax(f)}else a.local_data&&(d=b.grep(a.local_data,
function(b){return-1<b[a.propertyToSearch].toLowerCase().indexOf(c.toLowerCase())}),b.isFunction(a.onResult)&&(d=a.onResult.call(h,d)),J.add(e,d),G(c,d))}function I(){var b=a.url;"function"==typeof a.url&&(b=a.url.call());return b}"string"===b.type(l)||"function"===b.type(l)?(a.url=l,l=I(),void 0===a.crossDomain&&(-1===l.indexOf("://")?a.crossDomain=!1:a.crossDomain=location.href.split(/\/+/g)[1]!==l.split(/\/+/g)[1])):"object"===typeof l&&(a.local_data=l);a.classes?a.classes=b.extend({},E,a.classes):
a.theme?(a.classes={},b.each(E,function(b,e){a.classes[b]=e+"-"+a.theme})):a.classes=E;a.disableDelete&&(a.deleteText="");var p=[],m=0,J=new b.TokenList.Cache,O,K,g=b('<input type="text"  autocomplete="off" autocorrect="off" spellcheck="false">').css({outline:"none"}).attr("id",a.idPrefix+k.id).focus(function(){null!==a.tokenLimit&&a.tokenLimit===m||!a.hintText||(w.html("<p>"+a.hintText+"</p>"),C())}).blur(function(){n();b(this).val("")}).bind("keyup keydown blur update",function(){if(K!==(K=g.val())){var b=
K.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");P.html(b);g.width(P.width()+30)}}).keydown(function(c){var e,d;switch(c.keyCode){case 37:case 39:case 38:case 40:if(b(this).val())return e=null,e=40===c.keyCode||39===c.keyCode?b(t).next():b(t).prev(),e.length&&H(e),!1;e=u.prev();d=u.next();e.length&&e.get(0)===f||d.length&&d.get(0)===f?37===c.keyCode||38===c.keyCode?y(b(f),0):y(b(f),1):37!==c.keyCode&&38!==c.keyCode||!e.length?39!==c.keyCode&&40!==c.keyCode||!d.length||
A(b(d.get(0))):A(b(e.get(0)));break;case 8:if(a.disableDelete)break;e=u.prev();if(b(this).val().length)1===b(this).val().length?n():setTimeout(function(){N()},5);else return f?(B(b(f)),h.change()):e.length&&A(b(e.get(0))),!1;break;case 9:case 13:case 108:case 188:if(t)return F(b(t).data("tokeninput")),h.change(),!1;break;case 27:return n(),!0;default:String.fromCharCode(c.which)&&setTimeout(function(){N()},5)}}),h=b(k).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),f=null,
q=0,t=null,r=b("<ul />").addClass(a.classes.tokenList).click(function(a){if((a=b(a.target).closest("li"))&&a.get(0)&&b.data(a.get(0),"tokeninput")){var e=f;f&&y(b(f),2);e===a.get(0)?y(a,2):A(a)}else f&&y(b(f),2),g.focus()}).mouseover(function(c){(c=b(c.target).closest("li"))&&f!==this&&c.addClass(a.classes.highlightedToken)}).mouseout(function(c){(c=b(c.target).closest("li"))&&f!==this&&c.removeClass(a.classes.highlightedToken)}).insertAfter(h),u=b("<li />").addClass(a.classes.inputToken).appendTo(r).append(g),
w=b("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),P=b("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});h.val("");k=a.prePopulate||h.data("pre");a.processPrePopulate&&b.isFunction(a.onResult)&&(k=a.onResult.call(h,k));k&&k.length&&b.each(k,function(a,b){L(b);v()});b.isFunction(a.onReady)&&a.onReady.call();
this.getManualsettings=function(){return a};this.clear=function(){r.children("li").each(function(){0===b(this).children("input").length&&B(b(this))})};this.add=function(a){F(a)};this.destroy=function(a){this.remove(a);n()};this.remove=function(a){r.children("li").each(function(){if(0===b(this).children("input").length){var e=b(this).data("tokeninput"),d=!0,f;for(f in a)if(a[f]!==e[f]){d=!1;break}d&&B(b(this))}})};this.getTokens=function(){return p}};b.TokenList.Cache=function(k){var l=b.extend({max_size:500},
k),a={},v=0;this.add=function(b,k){v>l.max_size&&(a={},v=0);a[b]||(v+=1);a[b]=k};this.get=function(b){return a[b]}}})(jQuery);